/// DECLARE path=/help/monitors/nginx
/// DECLARE title=Nginx Monitor
/// DECLARE section=help
/// DECLARE subsection=monitors

<!-- Auto generated content below. DO NOT edit manually, but run tox -egenerate-monitor-docs command instead -->

# Nginx Monitor

This agent monitor plugin records performance and usage data from an nginx server.

@class=bg-warning docInfoPanel: An *agent monitor plugin* is a component of the Scalyr Agent. To use a plugin,
simply add it to the ``monitors`` section of the Scalyr Agent configuration file (``/etc/scalyr/agent.json``).
For more information, see [Agent Plugins](/help/scalyr-agent#plugins).

## Configuring Nginx

To use this monitor, you will need to configure your nginx server to enable the status module. For details,
see the [nginx documentation](http://nginx.org/en/docs/http/ngx_http_stub_status_module.html).

First, verify that your nginx server supports the status module. Execute the following command:

    nginx -V 2>&1 | grep -o with-http_stub_status_module

The output ``with-http_stub_status_module`` indicates that your server supports the status module. Otherwise,
you will need to either recompile nginx with the ``--with-http_stub_status_module`` flag, or upgrade to a full
version of nginx that has been compiled with that flag.

Next, you must enable the status module, by updating the ``server`` configuration section of your nginx server.
This section can either be found in the ``nginx.conf`` file, or the file in your ``sites-available`` directory
that corresponds to your site. For most Linux systems, these are located at ``/etc/nginx/nginx.conf`` and
``/etc/nginx/sites-available``.

Add the following configuration inside the ``server { ... }`` stanza:

    location /nginx_status {
      stub_status on;      # enable the status module
      allow 127.0.0.1;     # allow connections from localhost only
      deny all;            # deny every other connection
    }

This specifies that the status page should be served at ``http://<address>/nginx_status``, and can't be accessed
from other servers.

Each time the Scalyr agent fetches ``/nginx_status``, an entry will be added to the Nginx access log. If you wish to
prevent this, add the line ``access_log off;`` to the above configuration.

Once you make the configuration change, you will need to restart Nginx.  On most Linux systems, use the following
command:

    sudo service nginx restart

To verify that the status module is working properly, you can view it manually. Execute this command on the server
(substituting the appropriate port number as needed):

    curl http://localhost:80/nginx_status

If you have any difficulty enabling the status module, drop us a line at [support@scalyr.com](mailto:support@scalyr.com).

## Sample Configuration

Here is a typical configuration fragment:

    monitors: [
      {
          module: "scalyr_agent.builtin_monitors.nginx_monitor",
      }
    ]

If you were running an instances of Nginx on a non-standard port (say 8080), your config might resemble:

    monitors: [
      {
          module: "scalyr_agent.builtin_monitors.nginx_monitor",
          status_url: "http://localhost:8080/nginx_status"
          id: "customers"
      }
    ]

Note the ``id`` field in the configurations.  This is an optional field that allows you to specify an identifier
specific to a particular instance of Nginx and will make it easier to filter on metrics specific to that
instance.

accessLog:
## Uploading the nginx access log

If you have not already done so, you should also configure the Scalyr Agent to upload the access log
generated by nginx. Scalyr's nginx dashboard uses this log to generate many statistics.

For most Linux systems, the access log is saved in ``/var/log/nginx/access.log``. To upload, edit the
``logs`` section of ``/etc/scalyr-agent-2/agent.json``. Add the following entry:

    logs: [
       ...

    ***   {***
    ***     path: "/var/log/nginx/access.log",***
    ***     attributes: {parser: "accessLog", serverType: "nginx"}***
    ***   }***
    ]

Edit the ``path`` field as appropriate for your system setup.


## Viewing Data

After adding this plugin to the agent configuration file, wait one minute for data to begin recording. Then
click the {{menuRef:Dashboards}} menu and select {{menuRef:Nginx}}. (The dashboard may not be listed until
the agent begins sending nginx data.) You will see an overview of nginx data across all servers where you are
running the nginx plugin. Use the {{menuRef:ServerHost}} dropdown to show data for a specific server.

See [Analyze Access Logs](/solutions/analyze-access-logs) for more information about working with web access logs.

## Configuration Reference

|||# Option            ||| Usage
|||# ``module``        ||| Always ``scalyr_agent.builtin_monitors.nginx_monitor``
|||# ``status_url``    ||| Optional (defaults to 'http://localhost/nginx_status').  The URL the monitor will fetchto \
                           retrieve the nginx status information.
|||# ``source_address``||| Optional (defaults to '127.0.0.1'). The IP address to be used as the source address when \
                           fetching the status URL.  Many servers require this to be 127.0.0.1 because they only \
                           server the status page to requests from localhost.
|||# ``id``            ||| Optional (defaults to empty string).  Included in each log message generated by this \
                           monitor, as a field named ``instance``. Allows you to distinguish between different nginx \
                           instances running on the same server.

## Log reference

Each event recorded by this plugin will have the following fields:

|||# Field       ||| Meaning
|||# ``monitor`` ||| Always ``nginx_monitor``.
|||# ``metric``  ||| The metric name.  See the metric tables for more information.
|||# ``value``   ||| The value of the metric.
|||# ``instance``||| The ``id`` value from the monitor configuration.

## Metrics

The table below describes the metrics recorded by the monitor.

|||# Metric                        ||| Description
|||# ``nginx.connections.active``  ||| This is the number of connections currently opened to the server.  The total number \
                                       of allowed connections is a function of the number of worker_processes and the \
                                       number of worker_connections configured within your Nginx configuration file.
|||# ``nginx.connections.reading`` ||| The number of connections currently reading from the clients.
|||# ``nginx.connections.writing`` ||| The number of connections currently writing to the clients.
|||# ``nginx.connections.waiting`` ||| The number of connections currently idle/sending keep alives.
