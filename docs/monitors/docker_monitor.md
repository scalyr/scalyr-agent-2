<!-- Auto generated content below. DO NOT edit manually, but run tox -egenerate-monitor-docs command instead -->

# Docker Monitor

This plugin uses the Docker API to detect all containers running on the local host, retrieves metrics for each of
them, and logs them to the Scalyr servers.

It can also collect all log messages written to stdout and stderr by those containers, in conjunction with syslog.
See the online documentation for more details.

## Docker Labels

You can configure the Scalyr Agent to upload customer attributes for your containers based on the labels you set on the container itself. This can be used to easily set the parser that should be used to parse the container's log, as well as adding in arbitrary labels on the container's log.

To use this functionality, you must properly configure the agent by setting the `labels_as_attributes` configuration option to `true`. All of the docker monitor configuration options related to this feature are as follows:`

* **labels\_as\_attributes** - When `true` upload labels that pass the include/exclude filters (see below) as log attributes for the logs generated by the container.  Defaults to `false`
*  **label\_include\_globs** - A list of [glob strings](https://docs.python.org/2/library/fnmatch.html) used to include labels to be uploaded as log attributes.  Any label that matches any glob in this list will be included as an attribute, as long as it not excluded by `label_exclude_globs`.  Defaults to `[ '*' ]` (everything)
*  **label\_exclude\_globs** - A list of glob strings used to exclude labels from being uploaded as log attributes.  Any label that matches any glob on this list will be excluded as an attribute.  Exclusion rules are applied *after* inclusion rules.  Defaults to `[ 'com.scalyr.config.*' ]`
*  **label_prefix** - A string to add to the beginning of any label key before uploading it as a log attribute.  e.g. if the value for `label_prefix` is `docker_` then the container labels `app` and `tier` will be uploaded to Scalyr with attribute keys `docker_app` and `docker_tier`.  Defaults to ''

You can change these config options by editing the `agent.d/docker.json` file. Please [follow the instructions here](https://www.scalyr.com/help/install-agent-docker#modify-config) to export the configuration of your running Scalyr Agent.

A sample configuration that uploaded the attributes `tier`, `app` and `region`, with the prefix `dl_` would look like this:

```
monitors: [
    {
    "module": "scalyr_agent.builtin_monitors.docker_monitor",
    ...
    labels_as_attributes: true,
    label_include_globs: ['tier', 'app', 'region' ],
    label_prefix: 'dl_'
    }
]
```

Note: Log attributes contribute towards your total log volume, so it is wise to limit the labels to a small set of approved values, to avoid paying for attributes that you don't need.

## Using Docker Labels for Configuration

You can also use docker labels to configure the log settings for a specific container, such as setting the parser or setting redaction rules.

The agent takes any label on a container that begins with `com.scalyr.config.log.` and maps it to the corresponding option in the `log_config` stanza for that container's logs (minus the prefix).

For example, if you add the following label to your container:

```
com.scalyr.config.log.parser=accessLog
```

The Scalyr Agent will automatically use the following for that containers's `log_config` stanza:

```
{ "parser": "accessLog" }
```

This feature is enabled by default, and by default any configuration labels are ignored by the `labels_as_attributes` option.  To turn off this feature entirely, you can set the `use_labels_for_log_config` option to `false` in the docker monitor configuration, and the agent will not process container labels for configuration options.

The following fields can be configured via container labels and behave as described in the [Scalyr help docs](https://www.scalyr.com/help/scalyr-agent#logUpload):

* parser
* attributes
* sampling_rules
* rename_logfile
* redaction_rules

Note: keys for docker labels cannot include underscores, so for all options that have an underscore in their name, replace it with a hyphen, and the Scalyr agent will map this to the appropriate option name. e.g. the labels:

```
com.scalyr.config.log.rename-logfile
```

Would be mapped to `rename_logfile`

### Mapping Configuration Options

The rules for mapping labels to objects and arrays are as follows:

Values separated by a period are mapped to object keys e.g. if a label on a given container was specified as:

```
com.scalyr.config.log.attributes.tier=prod
```

Then this would be mapped to the following object, which would then be applied to the log config for that container:

```
{ "attributes": { "tier": "prod" } }
```

Arrays can be specified by using one or more digits as the key, e.g. if the labels were

```
com.scalyr.config.log.sampling-rules.0.match-expression=INFO
com.scalyr.config.log.sampling-rules.0.sampling-rate=0.1
com.scalyr.config.log.sampling-rules.1.match-expression=FINE
com.scalyr.config.log.sampling-rules.1.sampling-rate=0
```

This will be mapped to the following structure:

```
{ "sampling_rules":
    [
    { "match_expression": "INFO", "sampling_rate": 0.1 },
    { "match_expression": "FINE", "sampling_rate": 0 }
    ]
}
```

Note: The Scalyr agent will automatically convert hyphens in the docker label keys to underscores.

Array keys are sorted by numeric order before processing and unique objects need to have different digits as the array key. If a sub-key has an identical array key as a previously seen sub-key, then the previous value of the sub-key is overwritten

There is no guarantee about the order of processing for items with the same numeric array key, so if the config was specified as:

```
com.scalyr.config.log.sampling_rules.0.match_expression=INFO
com.scalyr.config.log.sampling_rules.0.match_expression=FINE
```

It is not defined or guaranteed what the actual value will be (INFO or FINE).

## Syslog Monitor

If you wish to use labels and label configuration when using the syslog monitor to upload docker logs, you must still specify a docker monitor in your agent config, and set the docker label options in the docker monitor configuration.  These will then be used by the syslog monitor.

TODO:  Back fill the instructions here.

## Configuration Reference

|||# Option                       ||| Usage
|||# ``module``                   ||| Always ``scalyr_agent.builtin_monitors.docker_monitor``
|||# ``container_name``           ||| Optional (defaults to None). Defines a regular expression that matches the name \
                                      given to the container running the scalyr-agent.
If this is None, the scalyr \
                                      agent will look for a container running /usr/sbin/scalyr-agent-2 as the main \
                                      process.

|||# ``container_check_interval`` ||| Optional (defaults to 5). How often (in seconds) to check if containers have \
                                      been started or stopped.
|||# ``api_socket``               ||| Optional (defaults to /var/scalyr/docker.sock). Defines the unix socket used to \
                                      communicate with the docker API.   WARNING, if you have `mode` set to `syslog`, \
                                      you must also set the `docker_api_socket` configuration option in the syslog \
                                      monitor to this same value
Note:  You need to map the host's /run/docker.sock to \
                                      the same value as specified here, using the -v parameter, e.g.
	docker run -v \
                                      /run/docker.sock:/var/scalyr/docker.sock ...
|||# ``docker_api_version``       ||| Optional (defaults to 'auto'). The version of the Docker API to use.  WARNING, \
                                      if you have `mode` set to `syslog`, you must also set the `docker_api_version` \
                                      configuration option in the syslog monitor to this same value

|||# ``docker_log_prefix``        ||| Optional (defaults to docker). Prefix added to the start of all docker logs.
|||# ``docker_percpu_metrics``    ||| Optional (defaults to False). When `True`, emits cpu usage stats per core.  \
                                      Note: This is disabled by default because it can result in an excessive amount \
                                      of metric data on cpus with a large number of cores.
|||# ``max_previous_lines``       ||| Optional (defaults to 5000). The maximum number of lines to read backwards from \
                                      the end of the stdout/stderr logs
when starting to log a containers \
                                      stdout/stderr to find the last line that was sent to Scalyr.
|||# ``readback_buffer_size``     ||| Optional (defaults to 5k). The maximum number of bytes to read backwards from \
                                      the end of any log files on disk
when starting to log a containers \
                                      stdout/stderr.  This is used to find the most recent timestamp logged to file \
                                      was sent to Scalyr.
|||# ``log_mode``                 ||| Optional (defaults to "docker_api"). Determine which method is used to gather \
                                      logs from the local containers. If "docker_api", then this agent will use the \
                                      docker API to contact the local containers and pull logs from them.  If \
                                      "syslog", then this agent expects the other containers to push logs to this one \
                                      using the Docker syslog logging driver.  Currently, "syslog" is the preferred \
                                      method due to bugs/issues found with the docker API (To protect legacy behavior, \
                                      the default method is "docker_api").
|||# ``docker_raw_logs``          ||| Optional (defaults to True). If True, the docker monitor will use the raw log \
                                      files on disk to read logs.The location of the raw log file is obtained by \
                                      querying the path from the Docker API. If false, the logs will be streamed over \
                                      the Docker API.
|||# ``metrics_only``             ||| Optional (defaults to False). If true, the docker monitor will only log docker \
                                      metrics and not any other information about running containers.  If set to true, \
                                      this value overrides the config item 'report_container_metrics'

|||# ``container_globs``          ||| Optional (defaults to None). A whitelist of container name glob patterns to \
                                      monitor.  Only containers whose name matches one of the glob patterns will be \
                                      monitored.  If `None`, all container names are matched.  This value is applied \
                                      *before* `container_globs_exclude`
|||# ``container_globs_exclude``  ||| Optional (defaults to None). A blacklist of container name glob patterns to \
                                      exclude from monitoring.  Any container whose name matches one of the glob \
                                      patterns will not be monitored.  If `None`, all container names matched by \
                                      `container_globs` are monitored.  This value is applied *after* \
                                      `container_globs`
|||# ``report_container_metrics`` ||| Optional (defaults to True). If true, metrics will be collected from the \
                                      container and reported  to Scalyr.
|||# ``label_include_globs``      ||| Optional (defaults to ['*']). If `labels_as_attributes` is True then this option \
                                      is a list of glob strings used to include labels that should be uploaded as log \
                                      attributes.  The docker monitor first gets all container labels that match any \
                                      glob in this list and then filters out any labels that match any glob in \
                                      `label_exclude_globs`, and the final list is then uploaded as log attributes.
|||# ``label_exclude_globs``      ||| Optional (defaults to ['com.scalyr.config.*']). If `labels_as_attributes` is \
                                      True, then this is a list of glob strings used to exclude labels from being \
                                      uploaded as log attributes.  Any label whose key matches any glob on this list \
                                      will not be added as a log attribute.  Note: the globs in this list are applied \
                                      *after* `label_include_globs`
|||# ``labels_as_attributes``     ||| Optional (defaults to False). If true, the docker monitor will add any labels \
                                      found on the container as log attributes, after applying `label_include_globs` \
                                      and `label_exclude_globs`.
|||# ``label_prefix``             ||| Optional (defaults to ""). If `labels_as_attributes` is true, then append this \
                                      prefix to the start of each label before adding it to the log attributes
|||# ``use_labels_for_log_config``||| Optional (defaults to True). If true, the docker monitor will check each \
                                      container for any labels that begin with `com.scalyr.config.log.` and use those \
                                      labels (minus the prefix) as fields in the containers log_config.  Keys that \
                                      contain hyphens will automatically be converted to underscores.

## Metrics

The table below describes the metrics recorded by the monitor.


### Network metrics

|||# Metric                    ||| Description
|||# ``docker.net.rx_bytes``   ||| Total received bytes on the network interface
|||# ``docker.net.rx_dropped`` ||| Total receive packets dropped on the network interface
|||# ``docker.net.rx_errors``  ||| Total receive errors on the network interface
|||# ``docker.net.rx_packets`` ||| Total received packets on the network interface
|||# ``docker.net.tx_bytes``   ||| Total transmitted bytes on the network interface
|||# ``docker.net.tx_dropped`` ||| Total transmitted packets dropped on the network interface
|||# ``docker.net.tx_errors``  ||| Total transmission errors on the network interface
|||# ``docker.net.tx_packets`` ||| Total packets transmitted on the network intervace

### Memory metrics

|||# Metric                                        ||| Description
|||# ``docker.mem.stat.active_anon``               ||| The number of bytes of active memory backed by anonymous pages, \
                                                       excluding sub-cgroups.
|||# ``docker.mem.stat.active_file``               ||| The number of bytes of active memory backed by files, excluding \
                                                       sub-cgroups.
|||# ``docker.mem.stat.cache``                     ||| The number of bytes used for the cache, excluding sub-cgroups.
|||# ``docker.mem.stat.hierarchical_memory_limit`` ||| The memory limit in bytes for the container.
|||# ``docker.mem.stat.inactive_anon``             ||| The number of bytes of inactive memory in anonymous pages, \
                                                       excluding sub-cgroups.
|||# ``docker.mem.stat.inactive_file``             ||| The number of bytes of inactive memory in file pages, excluding \
                                                       sub-cgroups.
|||# ``docker.mem.stat.mapped_file``               ||| The number of bytes of mapped files, excluding sub-groups
|||# ``docker.mem.stat.pgfault``                   ||| The total number of page faults, excluding sub-cgroups.
|||# ``docker.mem.stat.pgmajfault``                ||| The number of major page faults, excluding sub-cgroups
|||# ``docker.mem.stat.pgpgin``                    ||| The number of charging events, excluding sub-cgroups
|||# ``docker.mem.stat.pgpgout``                   ||| The number of uncharging events, excluding sub-groups
|||# ``docker.mem.stat.rss``                       ||| The number of bytes of anonymous and swap cache memory (includes \
                                                       transparent hugepages), excluding sub-cgroups
|||# ``docker.mem.stat.rss_huge``                  ||| The number of bytes of anonymous transparent hugepages, excluding \
                                                       sub-cgroups
|||# ``docker.mem.stat.unevictable``               ||| The number of bytes of memory that cannot be reclaimed (mlocked \
                                                       etc), excluding sub-cgroups
|||# ``docker.mem.stat.writeback``                 ||| The number of bytes being written back to disk, excluding \
                                                       sub-cgroups
|||# ``docker.mem.stat.total_active_anon``         ||| The number of bytes of active memory backed by anonymous pages, \
                                                       including sub-cgroups.
|||# ``docker.mem.stat.total_active_file``         ||| The number of bytes of active memory backed by files, including \
                                                       sub-cgroups.
|||# ``docker.mem.stat.total_cache``               ||| The number of bytes used for the cache, including sub-cgroups.
|||# ``docker.mem.stat.total_inactive_anon``       ||| The number of bytes of inactive memory in anonymous pages, \
                                                       including sub-cgroups.
|||# ``docker.mem.stat.total_inactive_file``       ||| The number of bytes of inactive memory in file pages, including \
                                                       sub-cgroups.
|||# ``docker.mem.stat.total_mapped_file``         ||| The number of bytes of mapped files, including sub-groups
|||# ``docker.mem.stat.total_pgfault``             ||| The total number of page faults, including sub-cgroups.
|||# ``docker.mem.stat.total_pgmajfault``          ||| The number of major page faults, including sub-cgroups
|||# ``docker.mem.stat.total_pgpgin``              ||| The number of charging events, including sub-cgroups
|||# ``docker.mem.stat.total_pgpgout``             ||| The number of uncharging events, including sub-groups
|||# ``docker.mem.stat.total_rss``                 ||| The number of bytes of anonymous and swap cache memory (includes \
                                                       transparent hugepages), including sub-cgroups
|||# ``docker.mem.stat.total_rss_huge``            ||| The number of bytes of anonymous transparent hugepages, including \
                                                       sub-cgroups
|||# ``docker.mem.stat.total_unevictable``         ||| The number of bytes of memory that cannot be reclaimed (mlocked \
                                                       etc), including sub-cgroups
|||# ``docker.mem.stat.total_writeback``           ||| The number of bytes being written back to disk, including \
                                                       sub-cgroups
|||# ``docker.mem.max_usage``                      ||| The max amount of memory used by container in bytes.
|||# ``docker.mem.usage``                          ||| The current number of bytes used for memory including cache.
|||# ``docker.mem.fail_cnt``                       ||| The number of times the container hit its memory limit
|||# ``docker.mem.limit``                          ||| The memory limit for the container in bytes.

### CPU metrics

|||# Metric                                      ||| Description
|||# ``docker.cpu.usage``                        ||| Total CPU consumed by container in nanoseconds
|||# ``docker.cpu.system_cpu_usage``             ||| Total CPU consumed by container in kernel mode in nanoseconds
|||# ``docker.cpu.usage_in_usermode``            ||| Total CPU consumed by tasks of the cgroup in user mode in nanoseconds
|||# ``docker.cpu.total_usage``                  ||| Total CPU consumed by tasks of the cgroup in nanoseconds
|||# ``docker.cpu.usage_in_kernelmode``          ||| Total CPU consumed by tasks of the cgroup in kernel mode in \
                                                     nanoseconds
|||# ``docker.cpu.throttling.periods``           ||| The number of of periods with throttling active.
|||# ``docker.cpu.throttling.throttled_periods`` ||| The number of periods where the container hit its throttling limit
|||# ``docker.cpu.throttling.throttled_time``    ||| The aggregate amount of time the container was throttled in \
                                                     nanoseconds
